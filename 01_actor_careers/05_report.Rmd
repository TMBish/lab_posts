---
title: "Test RMD"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

## Intro

Stuff and text.

## Data

### Films

```{r}
library(readr)
library(dplyr)
library(tidyr)

films = read_csv("https://raw.githubusercontent.com/TMBish/lab_posts/master/01_actor_careers/00_full_film_data.csv") %>%
  filter(!is.na(title))

```

### Actors / Directors

```{r}

# library(gender)
# library(stringr)
# library(lubridate)
# 
# film_folk = read_csv("https://raw.githubusercontent.com/TMBish/lab_posts/master/01_actor_careers/00_actors_directors.csv")
# 
# film_folk[film_folk$dob < as.Date("1880-01-01"), "dob"] = as.Date("1880-01-01")
# 
# # Grep out first name and dob year for the gender function
# film_folk = 
#   film_folk %>%
#   mutate(
#     first_name = str_extract(name, "(?i)[a-z]+(?=\\s)"),
#     dob_year = year(dob)
#   )
#   
# # Distinct name, dob combos and predict gender
# genders = 
#   film_folk %>% 
#   distinct(first_name, dob_year) %>%
#   gender_df(name_col = "first_name", year_col = "dob_year") %>%
#   select("first_name" = name, gender, "dob_year" = year_min)

```

We should sense check the gender mapping. Let's take a random 10 people to check:

```{r}
genders %>%
  sample_n(10) %>%
  knitr::kable(caption = "Sense Checking the Gender Mapping")

```

Looks pretty, pretty, pretty good.

```{r}
# Join back the gender back to the main data
film_folk = 
  film_folk %>%
  left_join(genders)

```

## Gender Gap

Some text.
Some text.
Some text.
Some text.Some text.
Some text.
Some text.
Some text.
Some text.
Some text.
Some text.

```{r}
library(highcharter)
tmbish = 
  hc_theme(
    chart = list(
      backgroundColor = list("white"),
      style = list(
        fontFamily = "Droid Sans"
      )
    ),
    colors = list("#414141", "#FF6A5C", "#CCDFC8", "#056571"),
    title = list(
      style = list(fontWeight = "bold", color = "#414141"),
      align = "left"
    ),
    xAxis = list(
      gridLineColor = "#2196F3",
      lineColor = "#2196F3",
      gridLineWidth = 0.5,
      lineWidth = 0,
      title = list(style = list(fontWeight = "bold"))
    ),
    yAxis = list(
      gridLineColor = "#2196F3",
      lineColor = "#2196F3",
      gridLineWidth = 0.5,
      lineWidth = 0,
      title = list(style = list(weight = "bold"))
    ),
    subtitle = list(
      style = list(fontStyle = "italic", color ="#414141"), 
      align = "left"
    ),
    tooltip = list(
      borderWidth = 0,
      shape = "square",
      valueDecimals = 2
    )
  )


volume_data =
  films %>% 
  select(title, year, tomatometer, director, actor_1:actor_6) %>%
  gather("role", "name", director, actor_1:actor_6) %>%
  mutate(role = ifelse(role == "director", "Director", "Actor")) %>%
  inner_join(film_folk) %>%
  mutate(
    age_at_production = year - dob_year
  ) %>%
  filter(between(age_at_production, 10,100)) %>%
  select(name, gender, dob_year, age_at_production, year, role, tomatometer)

  temp = 
    volume_data %>%
    filter(
      !is.na(gender)
    ) %>%
    mutate(
      category = case_when(
        role == "Director" ~ "director",
        gender == "male" ~ "male_actor",
        TRUE ~ "female_actor"
      )
    ) %>% 
    group_by(category, age_at_production) %>%
    summarise(films = n()) %>%
    group_by(category) %>%
    mutate(percentage = films / sum(films))

```

<div id = "age_series_chart">
```{r}
chart_data = 
temp %>%
select(-films) %>%
spread(category, percentage) %>%
mutate(
  director = ifelse(!is.na(director), director, 0),
  female_actor = ifelse(!is.na(female_actor), female_actor, 0),
  male_actor = ifelse(!is.na(male_actor), male_actor, 0),
  director_cdf = cumsum(director),
  female_actor_cdf = cumsum(female_actor),
  male_actor_cdf = cumsum(male_actor)
)


convert_js_vec = function(vec) {
  
  js_string = vec %>% round(4) %>% paste(collapse = ",")
  
  return(JS( paste0("[", js_string, "]") ))
  
}

# For the javascript client side interactivity on the age series chart
female_cdf = chart_data$female_actor_cdf %>% convert_js_vec()
female_pdf = chart_data$female_actor %>% convert_js_vec()
male_cdf = chart_data$male_actor_cdf %>% convert_js_vec()
male_pdf = chart_data$male_actor %>% convert_js_vec()
dir_cdf = chart_data$director_cdf %>% convert_js_vec()
dir_pdf = chart_data$director %>% convert_js_vec()

chart = 
  highchart() %>%
  hc_add_theme(tmbish) %>%
  hc_chart(
    animation = list(duration = 2000)
  ) %>%
  hc_xAxis(
    categories = chart_data$age_at_production,
    title = list(text = "Age at Production")
  ) %>%
  hc_yAxis(
    title = list(text = "Probablity Density"),
    labels = list(formatter = JS("function(){return(Math.round(this.value * 1000) / 10 + '%')}"))
  ) %>%
  hc_title(text = "Female actors") %>%
  hc_subtitle(text = "Comparing male actors, (male) directors and female actors") %>%
  hc_add_series(
    name = "Director", 
    type = "spline",
    data = chart_data$director,
    marker = list(enabled = FALSE)
  ) %>%
  hc_add_series(
    name = "Male Actor",
    type = "spline",
    data = chart_data$male_actor,
    marker = list(enabled = FALSE)
  ) %>%
  hc_add_series(
    name = "Female Actor",
    type = "area",
    data = chart_data$female_actor,
    zIndex = -10,
    marker = list(enabled = FALSE),
    fillOpacity = 0.5
  )

chart
```
</div>

<button id = "update_age_series"> Show Cumulative Distribution </button>

## Measuring Performance

To investigate our hypothesis we must make a couple of assumptions. Since we don't have an individual actor / director performance (like we would have for players in a sporting contest for example) we'll have to assume an actor or director can have a tangible affect on the quality of the movie they appear in; there are obviously many other factors but this seems like a relatively safe assumption.

Further - for actors - we'll have to limit the dataset to actors that played an important role in the film. They  need to be prominent enough so as to affect the overall quality of the film. So while Michael Cera's cameo in *This is the End* was quality it can't be said that he influenced the rotten tomatoes rating of the film on his own.

<iframe width="560" height="315" src="https://www.youtube.com/embed/qIKPJlKHKxg" frameborder="0" allowfullscreen></iframe>

After looking through a few rotten tomatoes pages it seems limiting to the top 3 actors in a given film is a good rule of thumb for at least partially influncial performances.

### Average Performance by Age




## Housekeeping



<script>

  $(document).ready(function() {
  
  var show_cdf = false;
  
    $("#update_age_series").click(function(){
    
        var chart=$("#age_series_chart").find(".highchart").highcharts();
        
        if (show_cdf) {
        
          chart.yAxis[0].setExtremes(0,null);
          chart.yAxis[0].setTitle({text:"Probability Density", redraw:false});
          dir_pdf = `r dir_pdf`;
          female_pdf = `r female_pdf`;
          male_pdf = `r male_pdf`;
          chart.series[0].setData(dir_pdf);
          chart.series[1].setData(male_pdf);
          chart.series[2].setData(female_pdf);
          $("#update_age_series").html("Show Cumulative Distribution");
          
        } else {
        
          chart.yAxis[0].setExtremes(0,1);
          chart.yAxis[0].setTitle({text:"Cumulative Probability", redraw:false});
          dir_cdf = `r dir_cdf`;
          female_cdf = `r female_cdf`;
          male_cdf = `r male_cdf`;
          chart.series[0].setData(dir_cdf);
          chart.series[1].setData(male_cdf);
          chart.series[2].setData(female_cdf);
        
          $("#update_age_series").html("Show Density");
        };
        
        show_cdf = !show_cdf
        
    }); 
  });

</script>
