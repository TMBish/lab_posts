---
title: "Adding Interactivity to Static Rmarkdown Documents"
author: ~
date: "`r Sys.time()`"
day: "`r format(Sys.Date(), '%d')`"
month: "`r format(Sys.Date(), '%b')`"
year: "`r format(Sys.Date(), '%Y')`"
slug: adding-rmarkdown-interactivity
categories: []
tags: ["R", "R Markdown", "Javascript", "Highcharts"]
highlight: "kate"
description: "Interactivity can be added to static HTML R Markdown outputs by using a couple of cool tricks."
img: "bulletin-edition-1"
---

# Overview

Adding interactivity to data analytics outputs is a great tool to have in your toolkit.

As an R User you generally have a few major output options. However, it's not immediately obvious how interactive you can get within each format. 

- **Shiny Apps** are the most interactive format with few limitations but require a computer server to host. This can be too much overhead for smaller tasks.
- **Non-HTML Rmarkdown outputs** aren't very interactive. Text, plots and other outputs are statically assembled at runtime and the document stays that way.
- **HTML R markdown outputs** are a nice comprimise. They support superficially interactive elements (tooltips, action filtering) through HTML widgets. **AND** interactivity can be enhanced and that's the topic of this post!

The key concept to get your head around is the client / server model from web-development. The upshot here is that if you don't have a server (an engine to drive what content is shown) your interactivity is always limited. I can request my R markdown document to go and retrieve 10 extra rows from the database cause there's no one there to listen to me. Everything you allow the person (client) to see must be delivered to them when they open the document. The key to unlock interactivity in this context is with `htmlwidgets` and client side javascript.

# Generate Data

I'll create a toy example with the awesome `highcharter` package. Our aim will be to allow the user to switch between a view of probability density functions and cumulative distribution functions. If you forget the difference, don't worry it's not important.


```{r}
library(dplyr)
library(tidyr)

data <- data.frame(
  normal = rnorm(10000, 5, 2), # 1000 random from normal dist
  exponential = rexp(10000, 0.5), # 1000 random from exponential dist
  uniform = runif(10000, 0, 10) # 1000 random from uniform dist
)

# Data Manipulation
data %>%
  gather(distribution, value, normal:uniform) %>%
  mutate(value = value %>% round(1)) %>%
  filter(value >= 0, value <= 12) %>%
  group_by(distribution, value) %>%
  summarise(points = n()) %>%
  ungroup() %>% group_by(distribution) %>%
  mutate(density = points / sum(points)) %>%
  ungroup() %>%
  select(-points) -> density

density %>% head()

```


# Plot Data

```{r}

library(highcharter)

 
plot_data = density %>% spread(distribution, density)
# 
#   highchart() %>%
#   hc_add_theme(hc_theme_monokai()) %>%
#   hc_chart(
#     animation = list(duration = 2000),
#     height = 500
#   ) %>%
#   hc_xAxis(
#     title = list(text = "Value")
#   ) %>%
#   hc_yAxis(
#     title = list(text = "Probablity Density"),
#     labels = list(formatter = JS("function(){return(Math.round(this.value * 1000) / 10 + '%')}"))
#   ) %>%
#   hc_title(text = "3 Probability Densities") %>%
#   hc_add_series(
#     name = "Normal", 
#     type = "spline",
#     data = plot_data %>% select(x = value, y = normal) %>% list_parse()
#     #marker = list(enabled = FALSE)
#   ) %>%
#   hc_add_series(
#     name = "Exponential",
#     type = "spline",
#     data = plot_data %>% select(x = value, y = exponential) %>% list_parse()
#    # marker = list(enabled = FALSE)
#   ) %>%
#   hc_add_series(
#     name = "Uniform",
#     type = "spline",
#     data = plot_data %>% select(x = value, y = uniform) %>% list_parse()
#    # marker = list(enabled = FALSE)
#   ) -> chart
# 
# chart

hchart(density, "spline", hcaes(x = value, y = density, group = distribution))


```


# Add Interactivity


```{r}

# Get CDF from density dataframe
get_dist = function(df, var, type) {

  if (type=="pdf") {
    
   df %>%
    filter(distribution == !!var) %>% # Tidy Evaluation
    mutate(
      js_pair = paste0("[", value, "," , density %>% round(6), "]")
    ) %>%
    pull(js_pair) %>% # Just found this function, handy!
    return()
    
  } else {
    
   df %>%
    filter(distribution == !!var) %>% # Tidy Evaluation
    arrange(value) %>%
    mutate(
      cdf = cumsum(density),
      js_pair = paste0("[", value, "," , cdf %>% round(4), "]")
    ) %>%
    pull(js_pair) %>% # Just found this function, handy!
    return()
    
  }
  
}

# Conver R char vector of x, y pairs to JS array string
js_stringify = function(vec) {
  
  vec %>%
    paste(collapse = ",") %>%
    paste0("[", . , "]") %>%
    JS() %>%
    return()
  
}

# Javascriptise PDF Data
nor_pdf = get_dist(density, "normal", "pdf") %>% js_stringify()
exp_pdf = get_dist(density, "exponential", "pdf") %>% js_stringify()
uni_pdf = get_dist(density, "uniform", "pdf") %>% js_stringify()

# Javascriptise CDF Data
nor_cdf = get_dist(density, "normal", "cdf") %>% js_stringify()
exp_cdf = get_dist(density, "exponential", "cdf") %>% js_stringify()
uni_cdf = get_dist(density, "uniform", "cdf") %>% js_stringify()



```

# In action

```{r}

  highchart(elementId = "densities_v2") %>%
  hc_add_theme(hc_theme_monokai()) %>%
  hc_chart(
    animation = list(duration = 2000),
    height = 500
  ) %>%
  hc_xAxis(
    #categories = plot_data$value,
    title = list(text = "Value")
  ) %>%
  hc_yAxis(
    title = list(text = "Probablity Density"),
    labels = list(formatter = JS("function(){return(Math.round(this.value * 1000) / 10 + '%')}"))
  ) %>%
  hc_title(text = "3 Probability Densities") %>%
  hc_add_series(
    name = "Normal", 
    type = "spline",
    #data = plot_data$normal,
    data = plot_data %>% select(x = value, y = normal) %>% list_parse(),
    marker = list(enabled = FALSE)
  ) %>%
  hc_add_series(
    name = "Exponential",
    type = "spline",
    #data = plot_data$exponential,
    data= plot_data %>% select(x = value, y = exponential) %>% list_parse(),
    marker = list(enabled = FALSE)
  ) %>%
  hc_add_series(
    name = "Uniform",
    type = "spline",
    #data = plot_data$uniform,
    data = plot_data %>% select(x = value, y = uniform) %>% list_parse(),
    marker = list(enabled = FALSE)
  ) 

```

<button id="test"> Click Me </button>

<script>

  $(document).ready(function() {
  
    var show_cdf = true;
    
    $("#test").click(function(){
    
      var chart=$("#densities_v2").highcharts();
      
      if (!show_cdf) {
      
        chart.yAxis[0].setTitle({text:"Cumulative Probability", redraw:false});
        uni_cdf = `r uni_cdf`;
        nor_cdf = `r nor_cdf`;
        exp_cdf = `r exp_cdf`;
        chart.series[0].setData(nor_cdf);
        chart.series[1].setData(exp_cdf);
        chart.series[2].setData(uni_cdf);
        $("#test").html("Show Density");
        
      } else {
      
        chart.yAxis[0].setTitle({text:"Probability Density", redraw:false});
        uni_pdf = `r uni_pdf`;
        nor_pdf = `r nor_pdf`;
        exp_pdf = `r exp_pdf`;
        chart.series[0].setData(nor_pdf);
        chart.series[1].setData(exp_pdf);
        chart.series[2].setData(uni_pdf);
        $("#test").html("Show CDF");
      
    };
    
    show_cdf = !show_cdf;
    
    }); 
  });

</script>



```{class.source="language-javascript"}

$(document).ready(function() {

  var show_cdf = false;
  
  $("#test").click(function(){
  
    var chart=$("#densities_v2").find(".highchart").highcharts();
    
    if (show_cdf) {
    
      chart.yAxis[0].setExtremes(0,null);
      chart.yAxis[0].setTitle({text:"Probability Density", redraw:false});
      uni_cdf = `r uni_cdf`;
      nor_cdf = `r nor_cdf`;
      exp_cdf = `r exp_cdf`;
      chart.series[0].setData(uni_cdf);
      chart.series[1].setData(nor_cdf);
      chart.series[2].setData(exp_cdf);

    } else {
    
      chart.yAxis[0].setExtremes(0,1);
      chart.yAxis[0].setTitle({text:"Cumulative Probability", redraw:false});

      $("#update_age_series").html("Show Density");
    
  };
  
  show_cdf = !show_cdf
  
  }); 
});

```
